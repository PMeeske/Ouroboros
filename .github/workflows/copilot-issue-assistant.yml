name: Copilot Issue Assistant

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  analyze-issue:
    name: Analyze Issue with Copilot
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && contains(github.event.issue.labels.*.name, 'copilot-assist')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Get issue details
      id: issue
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.inputs?.issue_number || context.payload.issue.number;
          const issue = await github.rest.issues.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber
          });
          
          core.setOutput('number', issueNumber);
          core.setOutput('title', issue.data.title);
          core.setOutput('body', issue.data.body || '');
          
          return issue.data;
    
    - name: Analyze issue type
      id: analyze
      uses: actions/github-script@v7
      with:
        script: |
          const issueTitle = '${{ steps.issue.outputs.title }}'.toLowerCase();
          const issueBody = '${{ steps.issue.outputs.body }}'.toLowerCase();
          const combined = issueTitle + ' ' + issueBody;
          
          let issueType = 'general';
          
          if (/bug|error|fix|crash|fail/.test(combined)) {
            issueType = 'bug';
          } else if (/feature|enhance|add|implement|new/.test(combined)) {
            issueType = 'feature';
          } else if (/test|coverage|spec/.test(combined)) {
            issueType = 'test';
          } else if (/doc|documentation|readme/.test(combined)) {
            issueType = 'documentation';
          } else if (/refactor|improve|optimize/.test(combined)) {
            issueType = 'refactor';
          }
          
          core.setOutput('type', issueType);
          console.log(`Detected issue type: ${issueType}`);
          return issueType;
    
    - name: Search codebase for context
      id: context
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          const issueTitle = '${{ steps.issue.outputs.title }}';
          
          // Extract keywords (4+ letter words)
          const keywords = issueTitle
            .toLowerCase()
            .match(/\w{4,}/g)
            ?.slice(0, 5) || [];
          
          let output = '## ðŸ” Codebase Context Analysis\n\n';
          output += `Searching for relevant files related to: **${issueTitle}**\n\n`;
          output += '### Related Files\n\n';
          
          for (const keyword of keywords) {
            output += `#### Files mentioning '${keyword}':\n`;
            try {
              // Safely search for files containing the keyword
              const files = execSync(
                `find src -name "*.cs" -type f -exec grep -l "${keyword.replace(/[^a-zA-Z0-9]/g, '')}" {} \\; 2>/dev/null | head -5`,
                { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 }
              ).trim().split('\n').filter(f => f);
              
              files.forEach(file => {
                output += `- \`${file}\`\n`;
              });
            } catch (e) {
              // No files found or error - continue
            }
            output += '\n';
          }
          
          // Find related test files
          output += '### Related Test Files\n\n';
          try {
            const testFiles = execSync(
              'find src/MonadicPipeline.Tests -name "*.cs" -type f | head -10',
              { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 }
            ).trim().split('\n').filter(f => f);
            
            testFiles.forEach(file => {
              output += `- \`${file}\`\n`;
            });
          } catch (e) {
            output += '- No test files found\n';
          }
          
          // Write output to file
          fs.writeFileSync('context-analysis.md', output);
    
    - name: Generate implementation suggestions
      id: suggestions
      run: |
        ISSUE_TYPE="${{ steps.analyze.outputs.type }}"
        
        echo "" >> context-analysis.md
        echo "---" >> context-analysis.md
        echo "" >> context-analysis.md
        echo "## ðŸ’¡ Implementation Suggestions" >> context-analysis.md
        echo "" >> context-analysis.md
        
        case "$ISSUE_TYPE" in
          bug)
            echo "### Bug Fix Approach" >> context-analysis.md
            echo "" >> context-analysis.md
            echo "1. **Identify the root cause**: Review related files and recent changes" >> context-analysis.md
            echo "2. **Add failing test**: Create a test that reproduces the bug" >> context-analysis.md
            echo "3. **Implement fix**: Use monadic error handling (\`Result<T>\`)" >> context-analysis.md
            echo "4. **Verify fix**: Ensure test passes and no regressions" >> context-analysis.md
            echo "5. **Update docs**: Document any behavior changes" >> context-analysis.md
            ;;
          feature)
            echo "### Feature Implementation Approach" >> context-analysis.md
            echo "" >> context-analysis.md
            echo "1. **Define interface**: Create clean API following functional patterns" >> context-analysis.md
            echo "2. **Implement core logic**: Use monadic composition and Kleisli arrows" >> context-analysis.md
            echo "3. **Add tests**: Write comprehensive unit and integration tests" >> context-analysis.md
            echo "4. **Document usage**: Add examples and update README" >> context-analysis.md
            echo "5. **Integration**: Ensure compatibility with existing pipelines" >> context-analysis.md
            ;;
          test)
            echo "### Testing Approach" >> context-analysis.md
            echo "" >> context-analysis.md
            echo "1. **Test structure**: Follow existing test patterns in \`src/MonadicPipeline.Tests\`" >> context-analysis.md
            echo "2. **Coverage**: Aim for >80% coverage of new code" >> context-analysis.md
            echo "3. **Mocking**: Use proper mocking for external dependencies" >> context-analysis.md
            echo "4. **Edge cases**: Test error conditions and boundary cases" >> context-analysis.md
            ;;
          documentation)
            echo "### Documentation Approach" >> context-analysis.md
            echo "" >> context-analysis.md
            echo "1. **Update README**: Add clear examples and usage instructions" >> context-analysis.md
            echo "2. **XML docs**: Ensure all public APIs have XML documentation" >> context-analysis.md
            echo "3. **Examples**: Add code examples in \`src/MonadicPipeline.Examples\`" >> context-analysis.md
            echo "4. **Architecture docs**: Update \`docs/\` directory if needed" >> context-analysis.md
            ;;
          refactor)
            echo "### Refactoring Approach" >> context-analysis.md
            echo "" >> context-analysis.md
            echo "1. **Ensure tests exist**: Add tests before refactoring if missing" >> context-analysis.md
            echo "2. **Small iterations**: Make incremental changes" >> context-analysis.md
            echo "3. **Maintain compatibility**: Don't break existing APIs" >> context-analysis.md
            echo "4. **Follow patterns**: Use existing functional programming patterns" >> context-analysis.md
            echo "5. **Verify behavior**: Run full test suite after changes" >> context-analysis.md
            ;;
        esac
        
        echo "" >> context-analysis.md
        echo "### Key Guidelines" >> context-analysis.md
        echo "" >> context-analysis.md
        echo "- âœ… Use \`Result<T>\` and \`Option<T>\` monads for error handling" >> context-analysis.md
        echo "- âœ… Follow functional programming principles (immutability, pure functions)" >> context-analysis.md
        echo "- âœ… Use Kleisli arrows for composable pipeline operations" >> context-analysis.md
        echo "- âœ… Add comprehensive XML documentation for public APIs" >> context-analysis.md
        echo "- âœ… Write tests that validate monadic laws and composition" >> context-analysis.md
        echo "" >> context-analysis.md
        echo "ðŸ“˜ Review [GitHub Copilot Instructions](.github/copilot-instructions.md) for detailed coding guidelines." >> context-analysis.md
    
    - name: Add copilot-assist label
      uses: actions/github-script@v7
      with:
        script: |
          // Add copilot-assist label if not already present
          const { data: issue } = await github.rest.issues.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.issue.outputs.number }}
          });
          
          const hasLabel = issue.labels.some(label => 
            label.name === 'copilot-assist'
          );
          
          if (!hasLabel) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue.outputs.number }},
              labels: ['copilot-assist']
            });
            console.log('Added copilot-assist label');
          }
    
    - name: Post analysis comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const analysis = fs.readFileSync('context-analysis.md', 'utf8');
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.issue.outputs.number }},
            body: `## ðŸ¤– GitHub Copilot Issue Analysis\n\n${analysis}\n\n---\n\n**@copilot** has been automatically assigned to this issue.\n\n*This analysis was automatically generated. To regenerate, add the \`copilot-assist\` label or mention \`@copilot\` in a comment.*`
          });
    
    - name: Upload analysis artifacts
      uses: actions/upload-artifact@v4
      with:
        name: issue-analysis-${{ steps.issue.outputs.number }}
        path: context-analysis.md
        retention-days: 30
