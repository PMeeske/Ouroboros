name: Copilot Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    name: AI-Assisted Code Review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          src/**/*.cs
          **.csproj
    
    - name: Analyze code changes
      if: steps.changed-files.outputs.any_changed == 'true'
      id: analyze
      run: |
        echo "## ü§ñ GitHub Copilot Code Review" > review-summary.md
        echo "" >> review-summary.md
        echo "Analyzing code changes in PR #${{ github.event.pull_request.number }}" >> review-summary.md
        echo "" >> review-summary.md
        
        # Get list of changed files
        echo "### Changed Files" >> review-summary.md
        echo '```' >> review-summary.md
        echo "${{ steps.changed-files.outputs.all_changed_files }}" >> review-summary.md
        echo '```' >> review-summary.md
        echo "" >> review-summary.md
        
        # Static analysis suggestions
        echo "### Code Quality Suggestions" >> review-summary.md
        echo "" >> review-summary.md
        
        # Check for common patterns in C# code
        echo "#### Functional Programming Patterns" >> review-summary.md
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == *.cs ]]; then
            # Check for monadic error handling
            if grep -q "throw new" "$file" 2>/dev/null; then
              echo "- ‚ö†Ô∏è \`$file\`: Consider using \`Result<T>\` monad instead of throwing exceptions" >> review-summary.md
            fi
            
            # Check for null checks
            if grep -q "== null\|!= null" "$file" 2>/dev/null; then
              echo "- ‚ÑπÔ∏è \`$file\`: Consider using \`Option<T>\` monad for null safety" >> review-summary.md
            fi
            
            # Check for async/await patterns
            if grep -q "\.Result\|\.Wait()" "$file" 2>/dev/null; then
              echo "- ‚ö†Ô∏è \`$file\`: Avoid blocking async calls - use await instead" >> review-summary.md
            fi
          fi
        done
        
        echo "" >> review-summary.md
        echo "#### Documentation" >> review-summary.md
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == *.cs ]]; then
            # Check for public members without XML docs
            if grep -q "public class\|public interface\|public static" "$file" 2>/dev/null; then
              if ! grep -q "/// <summary>" "$file" 2>/dev/null; then
                echo "- üìù \`$file\`: Add XML documentation comments for public APIs" >> review-summary.md
              fi
            fi
          fi
        done
        
        echo "" >> review-summary.md
        echo "---" >> review-summary.md
        echo "" >> review-summary.md
        echo "üí° **Tip**: Review the [GitHub Copilot Instructions](.github/copilot-instructions.md) for project-specific coding guidelines." >> review-summary.md
        
        # Save summary for comment
        echo "REVIEW_SUMMARY<<EOF" >> $GITHUB_OUTPUT
        cat review-summary.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Check architectural patterns
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "" >> review-summary.md
        echo "### Architecture Review" >> review-summary.md
        echo "" >> review-summary.md
        
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == *.cs ]]; then
            # Check namespace conventions
            if grep -q "^namespace " "$file" 2>/dev/null; then
              namespace=$(grep "^namespace " "$file" | head -1 | sed 's/namespace //' | sed 's/;.*//' | tr -d ' ')
              if [[ "$namespace" != LangChainPipeline* ]] && [[ "$namespace" != MonadicPipeline* ]]; then
                echo "- ‚ö†Ô∏è \`$file\`: Namespace should follow LangChainPipeline.* or MonadicPipeline.* convention" >> review-summary.md
              fi
            fi
            
            # Check for immutability
            if grep -q "public.*{.*set;" "$file" 2>/dev/null; then
              echo "- ‚ÑπÔ∏è \`$file\`: Consider using init-only setters or immutable records for functional programming" >> review-summary.md
            fi
          fi
        done
    
    - name: Run linting
      if: steps.changed-files.outputs.any_changed == 'true'
      continue-on-error: true
      run: |
        dotnet restore
        dotnet build --configuration Release 2>&1 | tee build-output.txt || true
        
        echo "" >> review-summary.md
        echo "### Build Warnings" >> review-summary.md
        echo "" >> review-summary.md
        
        if grep -q "warning" build-output.txt; then
          echo '```' >> review-summary.md
          grep "warning" build-output.txt | head -10 >> review-summary.md
          echo '```' >> review-summary.md
        else
          echo "‚úÖ No build warnings detected" >> review-summary.md
        fi
    
    - name: Post review comment
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: copilot-review
        path: review-summary.md
    
    - name: Upload review artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: copilot-review-${{ github.event.pull_request.number }}
        path: |
          review-summary.md
          build-output.txt
        retention-days: 30
