name: Android App Build

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'src/MonadicPipeline.Android/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/MonadicPipeline.Android/**'
  workflow_dispatch:

# Cancel in-progress builds for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-android-project:
    name: Check if Android project exists
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      android_exists: ${{ steps.check.outputs.exists }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for Android project
      id: check
      run: |
        if [ -d "src/MonadicPipeline.Android" ] && [ -f "src/MonadicPipeline.Android/MonadicPipeline.Android.csproj" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âœ“ Android project found"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸  Android project not found, skipping build"
        fi

  build-android:
    name: Build Android APK
    needs: check-android-project
    if: needs.check-android-project.outputs.android_exists == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install MAUI workload
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 15
        max_attempts: 3
        retry_wait_seconds: 30
        command: |
          echo "Installing MAUI Android workload..."
          dotnet workload install maui-android --skip-sign-check --verbosity detailed
          echo "Verifying installation..."
          dotnet workload list
          echo "Workload installation complete."

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-android-${{ hashFiles('**/MonadicPipeline.Android.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-android-
          ${{ runner.os }}-nuget-

    - name: Restore dependencies (Core libraries)
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 3
        retry_wait_seconds: 30
        command: |
          echo "Restoring core dependencies..."
          cd src
          dotnet restore MonadicPipeline.Core/MonadicPipeline.Core.csproj
          dotnet restore MonadicPipeline.Domain/MonadicPipeline.Domain.csproj
          dotnet restore MonadicPipeline.Pipeline/MonadicPipeline.Pipeline.csproj
          dotnet restore MonadicPipeline.Tools/MonadicPipeline.Tools.csproj
          dotnet restore MonadicPipeline.Providers/MonadicPipeline.Providers.csproj
          dotnet restore MonadicPipeline.Agent/MonadicPipeline.Agent.csproj

    - name: Restore Android project dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 3
        retry_wait_seconds: 30
        command: |
          echo "Restoring Android project dependencies..."
          cd src/MonadicPipeline.Android
          dotnet restore --verbosity detailed

    - name: Build Android APK
      run: |
        echo "Building Android APK..."
        cd src/MonadicPipeline.Android
        dotnet build -c Release -f net10.0-android --verbosity normal
      timeout-minutes: 20

    - name: List build output
      if: always()
      run: |
        echo "Build output directory contents:"
        find src/MonadicPipeline.Android/bin -type f 2>/dev/null || echo "No build output found"

    - name: Find and verify APK
      id: find-apk
      run: |
        echo "Searching for APK files..."
        APK_PATH=$(find src/MonadicPipeline.Android/bin/Release/net10.0-android -name "*.apk" -type f 2>/dev/null | head -n 1)
        if [ -z "$APK_PATH" ]; then
          echo "Error: No APK found!"
          echo "Listing all files in build directory:"
          ls -R src/MonadicPipeline.Android/bin/ || echo "Build output directory not found"
          exit 1
        fi
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "Found APK at: $APK_PATH"
        ls -lh "$APK_PATH"

    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      continue-on-error: true
      with:
        name: monadic-pipeline-android-apk
        path: ${{ steps.find-apk.outputs.apk_path }}
        retention-days: 30
        if-no-files-found: error

    - name: Build summary
      if: success()
      run: |
        echo "## âœ… Android APK Built Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**APK Location:** \`${{ steps.find-apk.outputs.apk_path }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**File Size:** $(ls -lh ${{ steps.find-apk.outputs.apk_path }} | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download the APK from the workflow artifacts above." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract the APK file" >> $GITHUB_STEP_SUMMARY
        echo "3. Transfer to your Android device" >> $GITHUB_STEP_SUMMARY
        echo "4. Enable 'Install from Unknown Sources' in Android settings" >> $GITHUB_STEP_SUMMARY
        echo "5. Install the APK" >> $GITHUB_STEP_SUMMARY

    - name: Send email notification with APK download link
      if: success()
      uses: dawidd6/action-send-mail@v3
      continue-on-error: true
      timeout-minutes: 5
      env:
        HAS_SMTP_CONFIG: ${{ secrets.SMTP_SERVER != '' && secrets.SMTP_USERNAME != '' && secrets.SMTP_PASSWORD != '' && secrets.NOTIFICATION_EMAIL != '' }}
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "âœ… Android APK Build Successful - ${{ github.repository }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: ${{ secrets.SMTP_FROM_EMAIL }}
        body: |
          Hello,

          The Android APK has been successfully built for the MonadicPipeline app!

          ðŸ“± **Build Details:**
          - Repository: ${{ github.repository }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          - Commit Message: ${{ github.event.head_commit.message }}
          - Build Triggered By: ${{ github.actor }}

          ðŸ“¦ **APK Information:**
          - File: ${{ steps.find-apk.outputs.apk_path }}
          - Build Configuration: Release

          ðŸ”— **Download Link:**
          You can download the APK from the workflow artifacts:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ðŸ“² **Installation Instructions:**
          1. Download the artifact from the link above
          2. Extract the APK file from the ZIP
          3. Transfer to your Android device (via USB, email, or cloud storage)
          4. Enable "Install from Unknown Sources" in Android settings
          5. Open the APK file on your device to install

          â° **Note:** Artifacts are retained for 30 days

          This is an automated message from GitHub Actions.
        priority: normal
    
    - name: Email notification skipped
      if: success() && (secrets.SMTP_SERVER == '' || secrets.SMTP_USERNAME == '' || secrets.SMTP_PASSWORD == '' || secrets.NOTIFICATION_EMAIL == '')
      run: |
        echo "## ðŸ“§ Email Notification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸  Email notification skipped - SMTP credentials not configured" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To enable email notifications, configure these secrets:" >> $GITHUB_STEP_SUMMARY
        echo "- \`SMTP_SERVER\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`SMTP_PORT\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`SMTP_USERNAME\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`SMTP_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`SMTP_FROM_EMAIL\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`NOTIFICATION_EMAIL\`" >> $GITHUB_STEP_SUMMARY

    - name: Failure summary
      if: failure()
      run: |
        echo "## âŒ Android APK Build Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the workflow logs above for detailed error messages." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Common issues:" >> $GITHUB_STEP_SUMMARY
        echo "- MAUI workload installation failed" >> $GITHUB_STEP_SUMMARY
        echo "- Missing dependencies" >> $GITHUB_STEP_SUMMARY
        echo "- Build configuration errors" >> $GITHUB_STEP_SUMMARY

  android-skipped:
    name: Android Build Skipped
    needs: check-android-project
    if: needs.check-android-project.outputs.android_exists == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Android project not found
      run: |
        echo "## â„¹ï¸ Android Build Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Android project was not found in this repository." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Expected location**: \`src/MonadicPipeline.Android/\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This is normal if the Android app has not been created yet." >> $GITHUB_STEP_SUMMARY
