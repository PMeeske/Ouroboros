name: Copilot Custom Agent Task Processor

on:
  issues:
    types: [opened, labeled, edited]

permissions:
  issues: write
  contents: read

jobs:
  analyze:
    # Fire if:
    # - the new label (for "labeled" action) is any Copilot label, OR
    # - for opened/edited, the issue already has any Copilot labels, OR
    # - the title contains "[Copilot]"
    if: >
      (
        github.event.action == 'labeled' &&
        contains(fromJson('["copilot-agent","copilot-assist","copilot-automated","needs-copilot-review","triage"]'),
                 github.event.label.name)
      ) || (
        contains(github.event.issue.title, '[Copilot]') ||
        contains(github.event.issue.labels.*.name, 'copilot-agent') ||
        contains(github.event.issue.labels.*.name, 'copilot-assist') ||
        contains(github.event.issue.labels.*.name, 'copilot-automated') ||
        contains(github.event.issue.labels.*.name, 'needs-copilot-review') ||
        contains(github.event.issue.labels.*.name, 'triage')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Log task metadata
        run: |
          echo "Action: ${{ github.event.action }}"
          echo "Issue #: ${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "New label (if labeled): ${{ github.event.label.name }}"
          echo "All labels: ${{ toJson(github.event.issue.labels) }}"

      - name: Post agent analysis comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body = [
              'ðŸ¤– **Copilot Agent Analysis**',
              '',
              "I've detected this automated task and will begin processing it.",
              'I will analyze the request and provide recommendations shortly.',
              '',
              '_(Triggered by Copilot label or title match.)_'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body
            });
