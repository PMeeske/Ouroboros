# README Badge Update Workflow

This document describes the automated badge update system for the Ouroboros project README.

## Overview

The repository has two workflows that update test and coverage badges in `README.md`:

1. **Standalone Workflow**: `.github/workflows/update-coverage-badges.yml`
2. **Integrated Workflow**: `.github/workflows/dotnet-test-grid.yml` (update-readme job)

## Standalone Workflow: update-coverage-badges.yml

### Purpose
A lightweight workflow that downloads test results from completed test workflows and updates README badges WITHOUT re-running tests.

### Triggers
1. **After test workflows** - Automatically runs after `.NET Test Grid` or `.NET Integration Tests` complete successfully
2. **Manual dispatch** - Can be manually triggered from GitHub Actions UI

### What It Does
1. Downloads test results (TRX files) from the completed workflow via artifacts
2. Downloads coverage report from the completed workflow via artifacts
3. Parses test results from TRX files
4. Extracts line coverage percentage from reports
5. Updates README.md badges with correct URLs and colors
6. Commits changes only if badges actually changed
7. Uses `[skip ci]` to prevent infinite loops

**Note**: This workflow does NOT run tests - it only downloads results from the workflow that just completed, eliminating duplicate test execution.

### Badge Color Logic

#### Test Badge
- **Green**: All tests passing
- **Red**: Any tests failing
- **Light Grey**: No tests found

Badge format: `tests-{PASSED}%20passing-{COLOR}` or `tests-{PASSED}%20passing%2C%20{FAILED}%20failing-{COLOR}`

#### Coverage Badge
- **Green**: ≥80% line coverage
- **Yellow**: ≥50% line coverage
- **Orange**: ≥20% line coverage
- **Red**: <20% line coverage

Badge format: `coverage-{PERCENTAGE}%25-{COLOR}`

### Manual Execution

To manually update badges:

1. Go to Actions tab in GitHub
2. Select "Update Coverage Badges" workflow
3. Click "Run workflow"
4. Select branch (usually `main`)
5. Click "Run workflow" button

**Note**: When triggered manually, the workflow will attempt to download artifacts from the most recent test run. If no artifacts are available, the badges may not update correctly. It's recommended to let the workflow run automatically after test completion.

## Integrated Workflow: dotnet-test-grid.yml

### Purpose
The main test workflow that runs tests across multiple categories and updates badges as a final step.

### update-readme Job
This job runs after all test matrix jobs and coverage report generation. It:
1. Downloads test results from all matrix jobs
2. Downloads the aggregated coverage report
3. Calculates total test counts
4. Extracts coverage percentage
5. Updates README badges
6. Commits if changed

### When It Runs
- Only on push to `main` branch
- Only after successful test and coverage jobs
- Part of the comprehensive test grid workflow

## Technical Details

### Test Result Parsing
Test counts are extracted from `.trx` (Visual Studio Test Results) files using regex:
```bash
PASSED=$(grep -oP 'Counters[^>]*passed="\K[0-9]+' "$TRX_FILE" | head -1)
FAILED=$(grep -oP 'Counters[^>]*failed="\K[0-9]+' "$TRX_FILE" | head -1)
```

### Coverage Extraction
Coverage percentage is extracted from `SummaryGithub.md` generated by ReportGenerator:
```bash
COVERAGE=$(grep -oP '(?:Line coverage:|Lines:)\s*\K[0-9.]+(?=%)?' CoverageReport/SummaryGithub.md | head -1)
```

### Badge URL Format
Badges use shields.io with the format:
```
https://img.shields.io/badge/{LABEL}-{MESSAGE}-{COLOR}
```

Spaces are encoded as `%20`, commas as `%2C`, and percent signs as `%25`.

### Commit Message
Changes are committed with the message:
```
chore: update test coverage badges [skip ci]
```

The `[skip ci]` tag prevents the commit from triggering CI workflows, avoiding infinite loops.

## Troubleshooting

### Badges Not Updating

1. **Check workflow runs**: Go to Actions tab and verify the workflow completed successfully
2. **Check test results**: Ensure tests are actually running and producing results
3. **Check permissions**: Workflow needs `contents: write` permission
4. **Check branch**: Workflows only run on `main` branch (for integrated workflow)

### Incorrect Badge Values

1. **Check coverage report**: Verify `CoverageReport/SummaryGithub.md` is generated correctly
2. **Check test results**: Verify `.trx` files contain correct test counts
3. **Review workflow logs**: Look for parsing errors in "Calculate total test counts" and "Parse coverage percentage" steps

### Debugging

Both workflows include extensive logging:
- Lists files being processed
- Shows extracted values
- Displays before/after badge URLs
- Logs color calculations

Check the workflow logs for detailed information about what's happening.

## Badge Requirements Summary

From the original requirements:

### Coverage Badge
- URL: `https://img.shields.io/badge/coverage-{PERCENTAGE}%25-{COLOR}`
- Colors:
  - Green (≥80%)
  - Yellow (≥50%)
  - Orange (≥20%)
  - Red (<20%)

### Tests Badge
- URL: `https://img.shields.io/badge/tests-{PASSED}%20passing-{COLOR}` (or with failures)
- Colors:
  - Green (all pass)
  - Red (any failures)

### Commit Behavior
- Only commits when values actually change
- Uses `[skip ci]` in commit message
- Committed by `github-actions[bot]`

## Files Modified

- `.github/workflows/update-coverage-badges.yml` - New standalone workflow
- `.github/workflows/dotnet-test-grid.yml` - Enhanced existing workflow (update-readme job)
- `README.md` - Badges are automatically updated at lines 11-12

## Current Status

As of the implementation:
- **Current README badges**: coverage-0%, tests-1656 passing, 8 failing (outdated)
- **Actual metrics**: 8.4% coverage, 111 tests passing (from TEST_COVERAGE_REPORT.md)
- **Expected after workflow runs**: coverage-8.4% (red), tests-111 passing (green)

The workflows are now in place and will automatically update badges on the next:
- Push to main branch
- Test workflow completion
- Manual workflow dispatch
