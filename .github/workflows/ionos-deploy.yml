# This workflow builds and deploys MonadicPipeline to IONOS Cloud Kubernetes
#
# This workflow includes:
# - Testing: Runs xUnit tests before building images
# - Building: Creates Docker images for both CLI and WebAPI components
# - Registry: Pushes images to IONOS Container Registry
# - Deployment: Deploys both CLI and WebAPI to IONOS Kubernetes cluster
#
# Prerequisites:
# - IONOS Cloud Managed Kubernetes cluster
# - IONOS Container Registry enabled
# - kubectl configured with IONOS cluster access
#
# Required GitHub Secrets:
#   - IONOS_REGISTRY_USERNAME: IONOS Container Registry username
#   - IONOS_REGISTRY_PASSWORD: IONOS Container Registry password (or access token)
#   - IONOS_KUBECONFIG: Raw kubeconfig YAML content for IONOS Kubernetes cluster
#   - IONOS_ADMIN_USERNAME: IONOS Cloud API username for infrastructure management
#   - IONOS_ADMIN_PASSWORD: IONOS Cloud API password for infrastructure management
#
# Optional GitHub Secrets/Variables:
#   - IONOS_REGISTRY: Registry URL (default: adaptive-systems.cr.de-fra.ionos.com)
#   - IONOS_ADMIN_TOKEN: IONOS Cloud API token (alternative to username/password)
#
# To configure kubeconfig secret:
#   1. Download kubeconfig from IONOS Cloud Console
#   2. Copy the raw YAML content
#   3. Add to GitHub Secrets as IONOS_KUBECONFIG
#
# For more information:
#   - IONOS Cloud: https://cloud.ionos.com/
#   - Documentation: docs/IONOS_DEPLOYMENT_GUIDE.md

name: IONOS Cloud Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IONOS_REGISTRY: ${{ vars.IONOS_REGISTRY || 'adaptive-systems.cr.de-fra.ionos.com' }}
  NAMESPACE: monadic-pipeline
  CONTAINER_NAME_CLI: monadic-pipeline
  CONTAINER_NAME_WEBAPI: monadic-pipeline-webapi

jobs:
  infrastructure:
    name: Manage IONOS Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify IONOS Cloud API access
        env:
          IONOS_USERNAME: ${{ secrets.IONOS_ADMIN_USERNAME }}
          IONOS_PASSWORD: ${{ secrets.IONOS_ADMIN_PASSWORD }}
          IONOS_TOKEN: ${{ secrets.IONOS_ADMIN_TOKEN }}
        run: |
          echo "Verifying IONOS Cloud API connectivity..."

          # Use token if available, otherwise use basic auth
          if [ -n "$IONOS_TOKEN" ]; then
            AUTH_HEADER="Authorization: Bearer $IONOS_TOKEN"
          elif [ -n "$IONOS_USERNAME" ] && [ -n "$IONOS_PASSWORD" ]; then
            AUTH_HEADER="Authorization: Basic $(echo -n "$IONOS_USERNAME:$IONOS_PASSWORD" | base64)"
          else
            echo "⚠️  Warning: No IONOS admin credentials provided. Skipping infrastructure verification."
            echo "Set IONOS_ADMIN_USERNAME/IONOS_ADMIN_PASSWORD or IONOS_ADMIN_TOKEN secrets to enable infrastructure management."
            exit 0
          fi

          # Test API connectivity using IONOS Cloud API v6
          # Reference: .github/workflows/ionos-api.yaml (IONOS Cloud API OpenAPI Specification)
          response=$(curl -s -w "\n%{http_code}" -H "$AUTH_HEADER" \
            -H "Content-Type: application/json" \
            https://api.ionos.com/cloudapi/v6/ || echo "000")

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" = "200" ]; then
            echo "✓ Successfully connected to IONOS Cloud API"
            echo "✓ API Specification: .github/workflows/ionos-api.yaml"
          elif [ "$http_code" = "401" ]; then
            echo "❌ Authentication failed. Please verify IONOS_ADMIN credentials."
            exit 1
          elif [ "$http_code" = "000" ]; then
            echo "❌ Failed to connect to IONOS Cloud API"
            exit 1
          else
            echo "⚠️  Unexpected HTTP status code: $http_code"
            echo "Response: $(echo "$response" | head -n -1)"
          fi

      - name: Ensure infrastructure prerequisites
        env:
          IONOS_USERNAME: ${{ secrets.IONOS_ADMIN_USERNAME }}
          IONOS_PASSWORD: ${{ secrets.IONOS_ADMIN_PASSWORD }}
          IONOS_TOKEN: ${{ secrets.IONOS_ADMIN_TOKEN }}
        run: |
          # Skip if no credentials
          if [ -z "$IONOS_TOKEN" ] && [ -z "$IONOS_USERNAME" ]; then
            echo "⚠️  Skipping infrastructure management - no admin credentials configured"
            exit 0
          fi

          echo "Infrastructure management capabilities enabled via IONOS Cloud API v6"
          echo "API Reference: .github/workflows/ionos-api.yaml"
          echo ""
          echo "Available infrastructure operations:"
          echo "  - Data centers management"
          echo "  - Kubernetes cluster provisioning"
          echo "  - Network configuration"
          echo "  - Storage provisioning"
          echo ""
          echo "✅ Infrastructure as Code (IaC) available:"
          echo "   - Terraform configurations: terraform/"
          echo "   - Automated provisioning workflow: .github/workflows/terraform-infrastructure.yml"
          echo "   - Environment configs: terraform/environments/"
          echo ""
          echo "To provision infrastructure automatically, run the 'Terraform Infrastructure' workflow"
          echo "or use: cd terraform && terraform apply -var-file=environments/production.tfvars"

  test:
    name: Run Tests
    needs: [infrastructure]
    permissions:
      contents: read
      checks: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run xUnit tests
        run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: '**/test-results.trx'

  build-and-push:
    name: Build and Push Images
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to IONOS Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IONOS_REGISTRY }}
          username: ${{ secrets.IONOS_REGISTRY_USERNAME }}
          password: ${{ secrets.IONOS_REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push CLI image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_CLI }}:latest
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_CLI }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push WebAPI image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.webapi
          push: true
          tags: |
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_WEBAPI }}:latest
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_WEBAPI }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to IONOS Kubernetes
    needs: [build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl for IONOS
        run: |
          echo "${{ secrets.IONOS_KUBECONFIG }}" > kubeconfig.yaml
          export KUBECONFIG=$(pwd)/kubeconfig.yaml
          kubectl cluster-info
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create registry pull secret
        run: |
          kubectl create secret docker-registry ionos-registry-secret \
            --docker-server=${{ env.IONOS_REGISTRY }} \
            --docker-username=${{ secrets.IONOS_REGISTRY_USERNAME }} \
            --docker-password=${{ secrets.IONOS_REGISTRY_PASSWORD }} \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Prepare deployment manifests
        run: |
          # Create temporary directory for processed manifests
          mkdir -p /tmp/k8s-manifests

          # Copy and process cloud deployment manifests
          cp k8s/deployment.cloud.yaml /tmp/k8s-manifests/deployment.yaml
          cp k8s/webapi-deployment.cloud.yaml /tmp/k8s-manifests/webapi-deployment.yaml
          cp k8s/qdrant.yaml /tmp/k8s-manifests/qdrant.yaml
          cp k8s/ollama.yaml /tmp/k8s-manifests/ollama.yaml

          # Replace REGISTRY_URL with actual IONOS registry URL
          REGISTRY_URL="${{ env.IONOS_REGISTRY }}"
          sed -i "s|REGISTRY_URL|${REGISTRY_URL}|g" /tmp/k8s-manifests/deployment.yaml
          sed -i "s|REGISTRY_URL|${REGISTRY_URL}|g" /tmp/k8s-manifests/webapi-deployment.yaml

          # Update storage class for IONOS
          sed -i "s|storageClassName: managed-csi|storageClassName: ionos-enterprise-ssd|g" /tmp/k8s-manifests/qdrant.yaml
          sed -i "s|storageClassName: managed-csi|storageClassName: ionos-enterprise-ssd|g" /tmp/k8s-manifests/ollama.yaml

          # Enable imagePullSecrets for IONOS registry
          sed -i 's|# imagePullSecrets:|imagePullSecrets:|g' /tmp/k8s-manifests/deployment.yaml
          sed -i 's|#   - name: ionos-registry-secret|  - name: ionos-registry-secret|g' /tmp/k8s-manifests/deployment.yaml
          sed -i 's|# imagePullSecrets:|imagePullSecrets:|g' /tmp/k8s-manifests/webapi-deployment.yaml
          sed -i 's|#   - name: ionos-registry-secret|  - name: ionos-registry-secret|g' /tmp/k8s-manifests/webapi-deployment.yaml

      - name: Apply secrets and configmap
        run: |
          echo "⚠️  Applying secrets - ensure k8s/secrets.yaml is updated for production!"
          kubectl apply -f k8s/secrets.yaml
          kubectl apply -f k8s/configmap.yaml

      - name: Deploy dependencies
        run: |
          kubectl apply -f /tmp/k8s-manifests/ollama.yaml
          kubectl apply -f /tmp/k8s-manifests/qdrant.yaml
          kubectl apply -f k8s/jaeger.yaml

      - name: Deploy applications
        run: |
          kubectl apply -f /tmp/k8s-manifests/deployment.yaml
          kubectl apply -f /tmp/k8s-manifests/webapi-deployment.yaml

      - name: Wait for deployments
        run: |
          echo "Waiting for deployments to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment/ollama -n ${{ env.NAMESPACE }} || true
          kubectl wait --for=condition=available --timeout=300s deployment/qdrant -n ${{ env.NAMESPACE }} || true
          kubectl wait --for=condition=available --timeout=300s deployment/monadic-pipeline -n ${{ env.NAMESPACE }} || true
          kubectl wait --for=condition=available --timeout=300s deployment/monadic-pipeline-webapi -n ${{ env.NAMESPACE }} || true

      - name: Deployment summary
        run: |
          echo "================================================"
          echo "Deployment Complete!"
          echo "================================================"
          echo ""
          echo "Images deployed:"
          echo "  - ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_CLI }}:${{ github.sha }}"
          echo "  - ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_WEBAPI }}:${{ github.sha }}"
          echo ""
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo "Storage class: ionos-enterprise-ssd"
          echo ""
          echo "Check deployment status:"
          kubectl get all -n ${{ env.NAMESPACE }}
          echo ""
          kubectl get pvc -n ${{ env.NAMESPACE }}
