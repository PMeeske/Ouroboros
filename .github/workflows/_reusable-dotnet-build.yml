# Reusable workflow for .NET build
# Handles building .NET projects with proper error handling and caching

name: Reusable .NET Build

on:
  workflow_call:
    inputs:
      configuration:
        description: 'Build configuration (Debug/Release)'
        required: false
        type: string
        default: 'Release'
      projects:
        description: 'Space-separated list of project paths to build (empty = all)'
        required: false
        type: string
        default: ''
      exclude-tests:
        description: 'Exclude test projects from build'
        required: false
        type: boolean
        default: true
    outputs:
      build-status:
        description: 'Build status (success/failure)'
        value: ${{ jobs.build.outputs.status }}

jobs:
  build:
    name: Build .NET Projects
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    outputs:
      status: ${{ steps.set-status.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3  # v4.0.0
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-build-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-build-
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: dotnet restore --verbosity normal

      - name: Build specified projects
        id: build
        if: inputs.projects != ''
        run: |
          echo "Building specified projects..."
          for project in ${{ inputs.projects }}; do
            echo "Building: $project"
            dotnet build --configuration ${{ inputs.configuration }} --no-restore "$project"
          done
        timeout-minutes: 15

      - name: Build all projects (excluding tests)
        id: build-all
        if: inputs.projects == '' && inputs.exclude-tests
        run: |
          echo "Building all projects except tests..."
          # Build main projects separately from tests
          # Tests have TreatWarningsAsErrors=true which may fail on NuGet vulnerability warnings
          for project in \
            src/Ouroboros.Agent/Ouroboros.Agent.csproj \
            src/Ouroboros.CLI/Ouroboros.CLI.csproj \
            src/Ouroboros.Core/Ouroboros.Core.csproj \
            src/Ouroboros.Domain/Ouroboros.Domain.csproj \
            src/Ouroboros.Examples/Ouroboros.Examples.csproj \
            src/Ouroboros.Pipeline/Ouroboros.Pipeline.csproj \
            src/Ouroboros.Providers/Ouroboros.Providers.csproj \
            src/Ouroboros.Tools/Ouroboros.Tools.csproj \
            src/Ouroboros.WebApi/Ouroboros.WebApi.csproj
          do
            if [ -f "$project" ]; then
              echo "Building: $project"
              dotnet build --configuration ${{ inputs.configuration }} --no-restore "$project"
            else
              echo "âš ï¸ Project not found: $project (skipping)"
            fi
          done
        timeout-minutes: 15

      - name: Build entire solution
        id: build-solution
        if: inputs.projects == '' && !inputs.exclude-tests
        run: |
          echo "Building entire solution..."
          dotnet build --configuration ${{ inputs.configuration }} --no-restore
        timeout-minutes: 15

      - name: Set build status
        id: set-status
        if: always()
        run: |
          # Determine which build step ran and get its outcome
          if [ "${{ steps.build.outcome }}" != "" ] && [ "${{ steps.build.outcome }}" != "skipped" ]; then
            echo "status=${{ steps.build.outcome }}" >> $GITHUB_OUTPUT
          elif [ "${{ steps.build-all.outcome }}" != "" ] && [ "${{ steps.build-all.outcome }}" != "skipped" ]; then
            echo "status=${{ steps.build-all.outcome }}" >> $GITHUB_OUTPUT
          elif [ "${{ steps.build-solution.outcome }}" != "" ] && [ "${{ steps.build-solution.outcome }}" != "skipped" ]; then
            echo "status=${{ steps.build-solution.outcome }}" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Build summary
        if: always()
        run: |
          # Get the actual status from the step that ran
          STATUS="${{ steps.set-status.outputs.status }}"
          
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: ${{ inputs.configuration }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$STATUS" = "success" ]; then
            echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
