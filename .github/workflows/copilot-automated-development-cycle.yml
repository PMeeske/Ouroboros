name: Copilot Automated Development Cycle

on:
  schedule:
    # Run twice daily at 9 AM and 5 PM UTC
    - cron: '0 9,17 * * *'
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force cycle even if 5 PRs are open'
        required: false
        default: false
        type: boolean
      max_tasks:
        description: 'Maximum number of tasks to create'
        required: false
        default: 3
        type: number
      assign_unassigned:
        description: 'Assign Copilot to unassigned issues'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  COPILOT_AGENT_USER: ${{ secrets.COPILOT_AGENT_USER }} # optional

jobs:
  check-pr-limit:
    name: Check Open PR Limit
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      open_pr_count: ${{ steps.check.outputs.open_pr_count }}

    steps:
      - name: Check open PRs
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const copilotPRs = pullRequests.filter(pr => pr.head.ref.startsWith('copilot/'));
            const openCount = copilotPRs.length;
            const maxPRs = 5;
            const force = '${{ github.event.inputs.force }}' === 'true';

            console.log(`Open Copilot PRs: ${openCount}/${maxPRs}`);
            const canProceed = force || openCount < maxPRs;

            core.setOutput('can_proceed', canProceed);
            core.setOutput('open_pr_count', openCount);
            console.log(canProceed ? 'âœ… Can proceed with cycle' : 'âš ï¸ Max PRs reached');

  analyze-and-generate-tasks:
    name: Analyze Codebase and Generate Tasks
    runs-on: ubuntu-latest
    needs: check-pr-limit
    if: needs.check-pr-limit.outputs.can_proceed == 'true'
    outputs:
      tasks: ${{ steps.generate.outputs.tasks }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - run: dotnet restore
      - run: dotnet build --configuration Release --no-restore

      - name: Run code analysis
        run: |
          echo "Running code analysis..."
          mkdir -p analysis-output
          grep -rn "TODO\|FIXME" src --include="*.cs" | head -20 > analysis-output/todos.txt || echo "None found" > analysis-output/todos.txt
          echo "Analysis complete"

      - name: Generate improvement tasks
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const todos = fs.existsSync('analysis-output/todos.txt')
              ? fs.readFileSync('analysis-output/todos.txt', 'utf8').split('\n').filter(Boolean)
              : [];

            const tasks = [];
            if (todos.length && todos[0] !== 'None found') {
              tasks.push({
                title: 'Address TODOs',
                body: `Found TODOs:\n\n\`\`\`\n${todos.slice(0,5).join('\n')}\n\`\`\`\n\nPlease resolve these.`,
                labels: ['enhancement', 'copilot-automated']
              });
            }

            const tasksJson = JSON.stringify(tasks);
            const tasksBase64 = Buffer.from(tasksJson).toString('base64');
            core.setOutput('tasks', tasksBase64);

  create-improvement-issues:
    name: Create Improvement Issues
    runs-on: ubuntu-latest
    needs: [check-pr-limit, analyze-and-generate-tasks]
    if: needs.analyze-and-generate-tasks.outputs.tasks != ''

    steps:
      - name: Create issues (assign or label Copilot)
        uses: actions/github-script@v7
        with:
          script: |
            const tasksBase64 = '${{ needs.analyze-and-generate-tasks.outputs.tasks }}';
            const tasksJson = Buffer.from(tasksBase64, 'base64').toString('utf8');
            const tasks = JSON.parse(tasksJson);
            const copilotUser = process.env.COPILOT_AGENT_USER || null;

            for (const task of tasks) {
              try {
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Copilot] ${task.title}`,
                  body: `${task.body}\n\n---\n\nðŸ¤– Automated Copilot Task`,
                  labels: [...task.labels, 'copilot-assist']
                });

                if (copilotUser) {
                  try {
                    await github.rest.issues.addAssignees({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.data.number,
                      assignees: [copilotUser]
                    });
                    console.log(`âœ… Assigned ${copilotUser} to issue #${issue.data.number}`);
                  } catch (err) {
                    console.log(`âš ï¸ Could not assign ${copilotUser}: ${err.message}`);
                  }
                } else {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.data.number,
                    labels: ['needs-copilot-review']
                  });
                  console.log(`â„¹ï¸ Added review label to issue #${issue.data.number}`);
                }

              } catch (e) {
                console.log(`âš ï¸ Failed to create issue: ${e.message}`);
              }
            }

  assign-copilot-to-unassigned:
    name: Assign Copilot to Unassigned Issues
    runs-on: ubuntu-latest
    needs: check-pr-limit
    if: always() && (github.event.inputs.assign_unassigned != 'false')

    steps:
      - name: Find and assign or label unassigned Copilot issues
        uses: actions/github-script@v7
        with:
          script: |
            const copilotUser = process.env.COPILOT_AGENT_USER || null;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            for (const issue of issues) {
              if (issue.pull_request || (issue.assignees && issue.assignees.length > 0)) continue;
              const labels = issue.labels.map(l => l.name);
              if (labels.includes('copilot-automated') || issue.title.includes('[Copilot]')) {
                if (copilotUser) {
                  try {
                    await github.rest.issues.addAssignees({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      assignees: [copilotUser]
                    });
                    console.log(`âœ… Assigned ${copilotUser} to #${issue.number}`);
                  } catch (err) {
                    console.log(`âš ï¸ Could not assign ${copilotUser}: ${err.message}`);
                  }
                } else {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['needs-copilot-review']
                  });
                  console.log(`â„¹ï¸ Added review label to #${issue.number}`);
                }
              }
            }

  update-cycle-status:
    name: Update Cycle Status
    runs-on: ubuntu-latest
    needs: [check-pr-limit, analyze-and-generate-tasks, create-improvement-issues, assign-copilot-to-unassigned]
    if: always()

    steps:
      - name: Update or create tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'copilot-cycle-tracker'
            });

            const status = '${{ needs.check-pr-limit.outputs.can_proceed }}' === 'true' ? 'ðŸŸ¢ Active' : 'ðŸŸ¡ Paused';
            const body = `# ðŸ¤– Copilot Development Cycle\n\nStatus: **${status}**\n\nLast run: ${now.toISOString()}`;

            let tracker = issues.find(i => i.title.includes('Development Cycle Status'));
            if (tracker) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: tracker.number,
                body
              });
              console.log(`âœ… Updated tracking issue #${tracker.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ¤– Copilot Development Cycle Status',
                body,
                labels: ['copilot-cycle-tracker']
              });
              console.log('âœ… Created new tracking issue');
            }
