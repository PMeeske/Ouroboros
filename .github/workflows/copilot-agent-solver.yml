name: Copilot Agent Solver

on:
  issues:
    types:
      - opened
      - labeled

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  dispatch-copilot-agent:
    if: contains(github.event.issue.labels.*.name, 'copilot-agent')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup and Run Copilot
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_BOT_TOKEN }}
          GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          echo "Setting up GitHub CLI configuration..."
          
          # Create the config directory
          mkdir -p ~/.config/gh
          
          # Create hosts.yml with oauth_token
          echo "github.com:" > ~/.config/gh/hosts.yml
          echo "    user: PMeeske" >> ~/.config/gh/hosts.yml
          echo "    oauth_token: ${GITHUB_TOKEN}" >> ~/.config/gh/hosts.yml
          echo "    git_protocol: https" >> ~/.config/gh/hosts.yml
          
          # Create config.yml to disable telemetry prompt
          echo "# Disable telemetry and prompts" > ~/.config/gh/config.yml
          echo "version: 1" >> ~/.config/gh/config.yml
          echo "prompt: disabled" >> ~/.config/gh/config.yml
          echo "telemetry: false" >> ~/.config/gh/config.yml
          
          # Also set environment variables to disable interactivity
          export GH_PROMPT_DISABLED=true
          export GH_NO_UPDATE_NOTIFIER=true
          export GITHUB_COPILOT_TELEMETRY_OPTOUT=true
          
          echo "Installing Copilot extension..."
          gh extension install github/gh-copilot --force
          
          echo "ü§ñ Attempting Copilot suggest with all prompts disabled..."
          
          # Method 1: Try with yes piped to answer the telemetry prompt
          echo "Method 1: Piping 'n' to answer telemetry prompt..."
          echo "n" | gh copilot suggest "Fix issue #${GH_ISSUE_NUMBER}: ${GH_ISSUE_TITLE}" --shell-out bash > copilot_plan.sh 2>&1 || {
            echo "Method 1 failed. Output:"
            cat copilot_plan.sh
            
            # Method 2: Try with expect if available
            echo "Method 2: Trying with timeout and forced input..."
            timeout 5 bash -c 'echo -e "n\n" | gh copilot suggest "Fix issue #'${GH_ISSUE_NUMBER}': '${GH_ISSUE_TITLE}'" --shell-out bash' > copilot_plan.sh 2>&1 || {
              echo "Method 2 failed. Output:"
              cat copilot_plan.sh
              
              # Method 3: Background process with input
              echo "Method 3: Background with input redirection..."
              ( echo "n" | gh copilot suggest "Fix issue #${GH_ISSUE_NUMBER}: ${GH_ISSUE_TITLE}" --shell-out bash & ) > copilot_plan.sh 2>&1
              sleep 3
              pkill -f "gh copilot" || true
              
              echo "Final output:"
              cat copilot_plan.sh
            }
          }
          
          # Check if we got any valid output
          if [ -f copilot_plan.sh ] && grep -q "#!/" copilot_plan.sh; then
            echo "‚úÖ Copilot plan generated successfully!"
            chmod +x copilot_plan.sh
            ./copilot_plan.sh
          else
            echo "‚ùå Failed to generate a valid plan"
            echo "Final debugging: Let's check what token type gh actually sees..."
            gh api user --jq '.login + " (token type: " + .__typename + ")"' || echo "Could not determine token type"
            exit 1
          fi

      - name: Create Pull Request
        if: success()
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_BOT_TOKEN }}
          GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet HEAD 2>/dev/null; then
            echo "‚úÖ Changes detected. Creating Pull Request..."
            gh pr create \
              --title "ü§ñ Copilot fix for #${GH_ISSUE_NUMBER}" \
              --body "Automated fix for issue #${GH_ISSUE_NUMBER}." \
              --base main
          else
            echo "‚ö†Ô∏è No changes were made."
          fi
