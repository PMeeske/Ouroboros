name: Copilot Agent Solver

on:
  issues:
    types:
      - opened
      - labeled

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  dispatch-copilot-agent:
    if: contains(github.event.issue.labels.*.name, 'copilot-agent')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup and Run Copilot
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_BOT_TOKEN }}
          GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          echo "üîç Debugging: Let's see what gh copilot is looking for..."
          
          # First, let's see where gh stores its config
          echo "GitHub CLI config location:"
          gh config list
          echo "---"
          
          # Try to understand what's in the .config directory
          echo "Config directory contents:"
          ls -la ~/.config/gh/ 2>/dev/null || echo "No ~/.config/gh directory"
          echo "---"
          
          # Check if there's a hosts.yml file
          echo "Hosts config:"
          cat ~/.config/gh/hosts.yml 2>/dev/null || echo "No hosts.yml file"
          echo "---"
          
          # Install extension with debug output
          echo "Installing Copilot extension with verbose output..."
          GH_DEBUG=1 gh extension install github/gh-copilot --force
          echo "---"
          
          # Try to manually create an OAuth-style token entry
          echo "Attempting to manually configure OAuth token..."
          mkdir -p ~/.config/gh
          cat > ~/.config/gh/hosts.yml << EOF
github.com:
    user: PMeeske
    oauth_token: ${GITHUB_TOKEN}
    git_protocol: https
EOF
          
          echo "Updated hosts.yml:"
          cat ~/.config/gh/hosts.yml
          echo "---"
          
          # Now try copilot with debug mode
          echo "ü§ñ Running Copilot suggest with debug output..."
          GH_DEBUG=1 gh copilot suggest "Fix issue #${GH_ISSUE_NUMBER}: ${GH_ISSUE_TITLE}" --shell-out bash 2>&1 | tee copilot_output.txt
          
          # Check what happened
          echo "---"
          echo "Copilot output analysis:"
          if grep -q "Error" copilot_output.txt; then
            echo "‚ùå Error detected. Full output:"
            cat copilot_output.txt
            
            # Last resort: Try the experimental API approach
            echo "---"
            echo "üî¨ Attempting experimental API call..."
            curl -X POST \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/copilot/suggest \
              -d "{\"prompt\": \"Fix issue #${GH_ISSUE_NUMBER}: ${GH_ISSUE_TITLE}\", \"language\": \"bash\"}" \
              2>&1 | tee api_response.json
            
            echo "API Response:"
            cat api_response.json
          else
            echo "‚úÖ Success? Checking for plan file..."
            if [ -f copilot_plan.sh ]; then
              cat copilot_plan.sh
            fi
          fi

      - name: Create Pull Request
        if: success()
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_BOT_TOKEN }}
          GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet HEAD 2>/dev/null; then
            echo "‚úÖ Changes detected. Creating Pull Request..."
            gh pr create \
              --title "ü§ñ Copilot fix for #${GH_ISSUE_NUMBER}" \
              --body "Automated fix for issue #${GH_ISSUE_NUMBER}." \
              --base main
          else
            echo "‚ö†Ô∏è No changes were made."
          fi
