name: Update Coverage Badges

on:
  # Trigger after test/coverage workflows complete
  workflow_run:
    workflows: [".NET Test Grid", ".NET Integration Tests"]
    types:
      - completed
    branches: [ main ]
  
  # Manual workflow dispatch
  workflow_dispatch:

permissions:
  contents: write

# Prevent concurrent badge updates
concurrency:
  group: update-badges
  cancel-in-progress: false

jobs:
  update-badges:
    name: Update README Badges
    runs-on: ubuntu-latest
    # Only run when test workflows succeed or on manual dispatch
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download test results from completed workflow
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@87c55149d96e628cc2ef7e6fc2aab372015aec85  # v4.1.8
      continue-on-error: true
      with:
        pattern: unit-test-results-*
        path: TestResults
        merge-multiple: true
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Download coverage report from completed workflow
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@87c55149d96e628cc2ef7e6fc2aab372015aec85  # v4.1.8
      continue-on-error: true
      with:
        name: coverage-report
        path: CoverageReport
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Parse test results
      id: test-results
      run: |
        TOTAL_PASSED=0
        TOTAL_FAILED=0
        
        echo "Parsing test results from TRX files..."
        
        # Check if grep supports Perl regex
        GREP_P_SUPPORTED=false
        if echo "test" | grep -P "test" &> /dev/null; then
          GREP_P_SUPPORTED=true
          echo "Using grep -P for parsing"
        else
          echo "Using sed for parsing (grep -P not available)"
        fi
        
        # Parse all TRX files
        for TRX_FILE in TestResults/*.trx; do
          if [ -f "$TRX_FILE" ]; then
            echo "Processing: $TRX_FILE"
            
            # Try Perl-compatible regex if available
            # Note: These patterns use advanced features (\K) that only work with Perl regex
            # They only run if grep -P test passed, otherwise sed fallback is used
            if [ "$GREP_P_SUPPORTED" = true ]; then
              PASSED=$(grep -oP 'Counters[^>]*passed="\K[0-9]+' "$TRX_FILE" 2>/dev/null | head -1 || echo "0")
              FAILED=$(grep -oP 'Counters[^>]*failed="\K[0-9]+' "$TRX_FILE" 2>/dev/null | head -1 || echo "0")
            else
              # Fallback to sed (more portable)
              PASSED=$(sed -n 's/.*<Counters.*passed="\([0-9]*\)".*/\1/p' "$TRX_FILE" | head -1 || echo "0")
              FAILED=$(sed -n 's/.*<Counters.*failed="\([0-9]*\)".*/\1/p' "$TRX_FILE" | head -1 || echo "0")
            fi
            
            echo "  Found: Passed=$PASSED, Failed=$FAILED"
            TOTAL_PASSED=$((TOTAL_PASSED + ${PASSED:-0}))
            TOTAL_FAILED=$((TOTAL_FAILED + ${FAILED:-0}))
          fi
        done
        
        echo "total_passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT
        echo "total_failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
        echo "Total: Passed=$TOTAL_PASSED, Failed=$TOTAL_FAILED"

    - name: Parse coverage percentage
      id: coverage
      run: |
        COVERAGE="0"
        
        if [ -f "CoverageReport/SummaryGithub.md" ]; then
          echo "Extracting coverage from SummaryGithub.md..."
          
          # Check if grep supports Perl regex
          GREP_P_SUPPORTED=false
          if echo "test" | grep -P "test" &> /dev/null; then
            GREP_P_SUPPORTED=true
            echo "Using grep -P for parsing"
          else
            echo "Using sed for parsing (grep -P not available)"
          fi
          
          # Try Perl-compatible regex if available
          # Note: These patterns use advanced Perl regex features (?:...), \K, (?=)
          # They only run if grep -P test passed, otherwise sed fallbacks are used
          if [ "$GREP_P_SUPPORTED" = true ]; then
            COVERAGE=$(grep -oP '(?:Line coverage:|Lines:)\s*\K[0-9.]+(?=%)?' CoverageReport/SummaryGithub.md 2>/dev/null | head -1 || echo "0")
            
            if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
              COVERAGE=$(grep -oP '\| Lines\s+\|\s+\K[0-9.]+' CoverageReport/SummaryGithub.md 2>/dev/null | head -1 || echo "0")
            fi
          fi
          
          # Fallback using sed (more portable) - try even if grep -P worked but returned 0
          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
            # Try to match "Line coverage: XX.X%" format
            COVERAGE=$(sed -n 's/.*Line coverage:.*\([0-9][0-9]*\.[0-9][0-9]*\)%.*/\1/p' CoverageReport/SummaryGithub.md | head -1 || echo "0")
          fi
          
          # Another sed fallback for table format "| Lines | XX.X% |"
          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
            COVERAGE=$(sed -n 's/^| Lines.*| \([0-9][0-9]*\.[0-9][0-9]*\)%.*/\1/p' CoverageReport/SummaryGithub.md | head -1 || echo "0")
          fi
          
          # Final fallback: just extract any percentage-like number after "Line" or "Lines"
          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
            COVERAGE=$(sed -n 's/.*Lines\?.*\([0-9][0-9]*\.[0-9][0-9]*\)%.*/\1/p' CoverageReport/SummaryGithub.md | head -1 || echo "0")
          fi
          
          echo "coverage=${COVERAGE:-0}" >> $GITHUB_OUTPUT
          echo "Coverage: ${COVERAGE}%"
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
          echo "No coverage report found, defaulting to 0%"
        fi

    - name: Update README badges
      id: update-badges
      run: |
        PASSED="${{ steps.test-results.outputs.total_passed }}"
        FAILED="${{ steps.test-results.outputs.total_failed }}"
        COVERAGE="${{ steps.coverage.outputs.coverage }}"
        
        echo "=== Badge Update Inputs ==="
        echo "Tests Passed: $PASSED"
        echo "Tests Failed: $FAILED"
        echo "Coverage: $COVERAGE%"
        echo ""
        
        # Determine test badge color
        # Requirements: green (all pass), red (any failures)
        if [ "$FAILED" = "0" ] && [ "$PASSED" -gt "0" ]; then
          TEST_COLOR="green"
          TEST_STATUS="${PASSED}%20passing"
        elif [ "$FAILED" -gt "0" ]; then
          TEST_COLOR="red"
          TEST_STATUS="${PASSED}%20passing%2C%20${FAILED}%20failing"
        else
          TEST_COLOR="lightgrey"
          TEST_STATUS="no%20tests"
        fi
        
        # Determine coverage badge color
        # Requirements: green (â‰¥80%), yellow (â‰¥50%), orange (â‰¥20%), red (<20%)
        if [ -n "$COVERAGE" ] && [ "$COVERAGE" != "0" ]; then
          COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
          if [ "$COVERAGE_INT" -ge 80 ]; then
            COV_COLOR="green"
          elif [ "$COVERAGE_INT" -ge 50 ]; then
            COV_COLOR="yellow"
          elif [ "$COVERAGE_INT" -ge 20 ]; then
            COV_COLOR="orange"
          else
            COV_COLOR="red"
          fi
        else
          COV_COLOR="red"
          COVERAGE="0"
        fi
        
        echo "=== Badge Colors ==="
        echo "Test badge: $TEST_STATUS ($TEST_COLOR)"
        echo "Coverage badge: ${COVERAGE}% ($COV_COLOR)"
        echo ""
        
        # Show current badges
        echo "=== Current Badges ==="
        grep "img.shields.io/badge/coverage-" README.md || echo "No coverage badge found"
        grep "img.shields.io/badge/tests-" README.md || echo "No tests badge found"
        echo ""
        
        # Update the tests badge
        sed -i "s|https://img.shields.io/badge/tests-[^\"]*|https://img.shields.io/badge/tests-${TEST_STATUS}-${TEST_COLOR}|g" README.md
        
        # Update the coverage badge (URL encode the percentage)
        COVERAGE_ENCODED=$(echo "$COVERAGE" | sed 's/%/%25/g')
        sed -i "s|https://img.shields.io/badge/coverage-[^\"]*|https://img.shields.io/badge/coverage-${COVERAGE_ENCODED}%25-${COV_COLOR}|g" README.md
        
        echo "=== Updated Badges ==="
        grep "img.shields.io/badge/coverage-" README.md || echo "No coverage badge found"
        grep "img.shields.io/badge/tests-" README.md || echo "No tests badge found"
        echo ""
        
        echo "âœ… Badge update complete"

    - name: Check for changes
      id: git-check
      run: |
        if git diff --quiet README.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes to README.md"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "README.md has been updated"
          echo ""
          echo "=== Changes Preview ==="
          git diff README.md
        fi

    - name: Commit and push changes
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md
        git commit -m "chore: update test coverage badges [skip ci]"
        git push
        echo "âœ… Changes committed and pushed"

    - name: Generate summary
      if: always()
      run: |
        PASSED="${{ steps.test-results.outputs.total_passed }}"
        FAILED="${{ steps.test-results.outputs.total_failed }}"
        COVERAGE="${{ steps.coverage.outputs.coverage }}"
        CHANGED="${{ steps.git-check.outputs.changed }}"
        
        echo "## ðŸ“Š Badge Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Passed:** $PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Failed:** $FAILED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- **Line Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Status" >> $GITHUB_STEP_SUMMARY
        if [ "$CHANGED" = "true" ]; then
          echo "âœ… README.md badges updated and committed" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes needed (badges already up-to-date)" >> $GITHUB_STEP_SUMMARY
        fi
